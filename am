#!/usr/bin/env bash
set -euo pipefail

# ============================================
# Intelligent wrapper for Alertmanager
# Automatically detects desired action
# ============================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
BLUE='\033[0;34m'
GREEN='\033[0;32m'
NC='\033[0m'

print_banner() {
    printf "${BLUE}"
    cat << 'EOF'
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘       ðŸ”” Alertmanager Silence Manager         â•‘
    â•‘                                               â•‘
    â•‘  A simple tool to manage your silences        â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
    printf "${NC}\n"
}

show_help() {
    printf "%b" "${GREEN}"
    printf "Usage:${NC}\n"
    echo "  $0 [COMMAND] [OPTIONS]"
    echo
    printf "%b" "${GREEN}"
    printf "Available commands:${NC}\n"
    echo
    printf "%b" "${GREEN}"
    printf "  Create a silence:${NC}\n"
    echo "    $0 create                    # Interactive mode"
    echo "    $0 create 60                 # 60 minutes"
    echo "    $0 create 120 \"My message\"   # 120 min with comment"
    echo "    $0 silence                   # Alias for create"
    echo "    $0                           # No args = interactive create"
    echo
    printf "%b" "${GREEN}"
    printf "  Manage silences:${NC}\n"
    echo "    $0 list                      # List all silences"
    echo "    $0 ls                        # Alias for list"
    echo "    $0 show SILENCE_ID           # Show silence details"
    echo "    $0 delete SILENCE_ID         # Delete a silence"
    echo "    $0 rm SILENCE_ID             # Alias for delete"
    echo "    $0 clean                     # Delete all silences"
    echo "    $0 manage                    # Interactive management mode"
    echo
    printf "%b" "${GREEN}"
    printf "  Information:${NC}\n"
    echo "    $0 help                      # Show this help"
    echo "    $0 version                   # Show version"
    echo
    printf "%b" "${GREEN}"
    printf "Examples:${NC}\n"
    echo "  $0                                    # Launch interactive menu"
    echo "  $0 create                             # Create a silence (interactive)"
    echo "  $0 create 30                          # 30 minutes silence"
    echo "  $0 create 120 \"Server maintenance\"    # 2h with comment"
    echo "  $0 list                               # View all silences"
    echo "  $0 delete abc123                      # Delete a silence"
    echo
    printf "%b" "${GREEN}"
    printf "Environment variables:${NC}\n"
    echo "  NAMESPACE       Kubernetes namespace (default: monitoring)"
    echo "  INGRESS_NAME    Ingress name (default: alertmanager)"
    echo
    printf "%b" "${GREEN}"
    printf "Examples with configuration:${NC}\n"
    echo "  NAMESPACE=prod $0 create 60"
    echo "  INGRESS_NAME=alertmanager-public $0 list"
    echo
}

main() {
    local action="${1:-create}"
    
    case "$action" in
        # Help and information
        help|-h|--help)
            print_banner
            show_help
            ;;
        
        version|-v|--version)
            echo "Alertmanager Silence Manager v1.0.0"
            echo "Scripts: alertmanager-silence.sh, silence-quick.sh, manage-silences.sh"
            ;;
        
        # Create silences
        create|silence|new)
            if [[ $# -eq 1 ]]; then
                # Interactive mode
                exec "$SCRIPT_DIR/alertmanager-silence.sh"
            else
                # Quick mode with arguments
                shift
                exec "$SCRIPT_DIR/silence-quick.sh" "$@"
            fi
            ;;
        
        # Manage silences
        list|ls)
            exec "$SCRIPT_DIR/manage-silences.sh" list
            ;;
        
        show|get|view)
            if [[ -z "${2:-}" ]]; then
                echo "âŒ Error: Silence ID required"
                echo "Usage: $0 show SILENCE_ID"
                exit 1
            fi
            exec "$SCRIPT_DIR/manage-silences.sh" show "$2"
            ;;
        
        delete|del|rm|remove)
            if [[ -z "${2:-}" ]]; then
                echo "âŒ Error: Silence ID required"
                echo "Usage: $0 delete SILENCE_ID"
                exit 1
            fi
            exec "$SCRIPT_DIR/manage-silences.sh" delete "$2"
            ;;
        
        clean|clear|delete-all)
            exec "$SCRIPT_DIR/manage-silences.sh" delete-all
            ;;
        
        manage|admin)
            exec "$SCRIPT_DIR/manage-silences.sh"
            ;;
        
        # Default: interactive creation mode
        *)
            if [[ "$action" =~ ^[0-9]+$ ]]; then
                # If first argument is a number, interpret as duration
                exec "$SCRIPT_DIR/silence-quick.sh" "$@"
            else
                echo "âŒ Unknown command: $action"
                echo
                show_help
                exit 1
            fi
            ;;
    esac
}

main "$@"
